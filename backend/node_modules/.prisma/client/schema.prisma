// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model roles {
  rol_id     Int       @id @default(autoincrement())
  nombre     String    @db.VarChar(100)
  deleted_at DateTime?

  usuarios usuarios[]
}

model finca {
  finca_id    Int       @id @default(autoincrement())
  nombre      String    @db.VarChar(255)
  descripcion String?
  ubicacion   String?
  deleted_at  DateTime?

  usuarios usuarios[]
}

model usuarios {
  usuario_id  Int       @id @default(autoincrement())
  finca_id    Int?
  rol_id      Int?
  nombre      String    @db.VarChar(255)
  correo      String    @unique @db.VarChar(255)
  contraseña String?
  deleted_at  DateTime?

  finca finca? @relation(fields: [finca_id], references: [finca_id])
  rol   roles? @relation(fields: [rol_id], references: [rol_id])

  // Relaciones corregidas con nombres únicos
  eventos_veterinario evento_sanitario[]    @relation("EventoSanitarioVeterinario")
  eventos_operador    evento_sanitario[]    @relation("EventoSanitarioOperador")
  alimentaciones      alimentacion[]
  pesajes_realizados  pesajes[]
  compras_realizadas  compras[]
  producciones_carne  produccion_carne[]
  producciones_leche  produccion_lechera[]
  montas_supervisadas evento_monta[]
  diagnosticos        diagnostico_preñez[]
  partos_veterinario  evento_parto[]        @relation("PartoVeterinario")
  partos_operador     evento_parto[]        @relation("PartoOperador")
}

model unidades {
  unidad_id  Int       @id @default(autoincrement())
  nombre     String    @db.VarChar(50)
  deleted_at DateTime?

  insumos            insumos[]
  pesajes            pesajes[]
  producciones_leche produccion_lechera[]
}

model tipo_insumo {
  tipo_insumo_id Int       @id @default(autoincrement())
  nombre         String    @db.VarChar(255)
  deleted_at     DateTime?

  insumos insumos[]
}

model insumos {
  insumo_id      Int       @id @default(autoincrement())
  tipo_insumo_id Int
  nombre         String    @db.VarChar(255)
  cantidad       Int
  unidad_id      Int
  descripcion    String?
  deleted_at     DateTime?

  tipo_insumo tipo_insumo @relation(fields: [tipo_insumo_id], references: [tipo_insumo_id])
  unidad      unidades    @relation(fields: [unidad_id], references: [unidad_id])

  detalle_compras detalle_compras[]
  evento_insumos  evento_insumo[]
  alimentaciones  alimentacion[]
}

model tipo_evento {
  tipo_evento_id Int       @id @default(autoincrement())
  nombre         String    @db.VarChar(255)
  padre_id       Int?
  deleted_at     DateTime?

  padre tipo_evento?  @relation("TipoEventoJerarquia", fields: [padre_id], references: [tipo_evento_id])
  hijos tipo_evento[] @relation("TipoEventoJerarquia")

  eventos_sanitarios evento_sanitario[]
  eventos_monta      evento_monta[]
  eventos_parto      evento_parto[]
}

model razas {
  raza_id     Int       @id @default(autoincrement())
  nombre      String    @db.VarChar(255)
  descripcion String?
  deleted_at  DateTime?

  animales animales[]
}

model potreros {
  potrero_id Int       @id @default(autoincrement())
  ubicacion  String    @db.VarChar(255)
  deleted_at DateTime?

  lotes lotes[]
}

model lotes {
  lote_id     Int       @id @default(autoincrement())
  potrero_id  Int
  descripcion String?
  deleted_at  DateTime?

  potrero  potreros   @relation(fields: [potrero_id], references: [potrero_id])
  animales animales[]
}

model animales {
  animal_id        Int       @id @default(autoincrement())
  animal_madre_id  Int?
  animal_padre_id  Int?
  lote_id          Int?
  raza_id          Int
  animal_img       String?   @db.VarChar(255)
  arete            String    @unique @db.VarChar(100)
  sexo             String    @db.Char(1)
  fecha_destete    DateTime?
  fecha_nacimiento DateTime
  deleted_at       DateTime?

  madre       animales?  @relation("Madre", fields: [animal_madre_id], references: [animal_id])
  padre       animales?  @relation("Padre", fields: [animal_padre_id], references: [animal_id])
  hijos_madre animales[] @relation("Madre")
  hijos_padre animales[] @relation("Padre")

  lote lotes? @relation(fields: [lote_id], references: [lote_id])
  raza razas  @relation(fields: [raza_id], references: [raza_id])

  eventos_sanitarios evento_sanitario[]
  alimentaciones     alimentacion[]
  pesajes            pesajes[]
  producciones_carne produccion_carne[]
  producciones_leche produccion_lechera[]
  montas_hembra      evento_monta[]       @relation("MontaHembra")
  montas_macho       evento_monta[]       @relation("MontaMacho")
  partos             evento_parto[]
}

model proveedores {
  proveedor_id     Int       @id @default(autoincrement())
  nombre_compañia String    @db.VarChar(255)
  nombre_contacto  String?   @db.VarChar(255)
  telefono         String?   @db.VarChar(20)
  deleted_at       DateTime?

  compras compras[]
}

model compras {
  compra_id           Int       @id @default(autoincrement())
  usuario_contable_id Int
  proveedor_id        Int
  fecha               DateTime
  deleted_at          DateTime?

  usuario_contable usuarios          @relation(fields: [usuario_contable_id], references: [usuario_id])
  proveedor        proveedores       @relation(fields: [proveedor_id], references: [proveedor_id])
  detalle_compras  detalle_compras[]
}

model detalle_compras {
  detalle_id Int       @id @default(autoincrement())
  compra_id  Int
  insumo_id  Int
  precio     Decimal   @db.Decimal(10, 2)
  cantidad   Int
  deleted_at DateTime?

  compra compras @relation(fields: [compra_id], references: [compra_id])
  insumo insumos @relation(fields: [insumo_id], references: [insumo_id])
}

model evento_sanitario {
  evento_sanitario_id    Int       @id @default(autoincrement())
  animal_id              Int
  tipo_evento_id         Int
  usuario_veterinario_id Int
  usuario_operador_id    Int
  estado                 String?   @db.VarChar(100)
  diagnostico            String?
  tratamiento            String?
  fecha_diagnostico      DateTime?
  fecha                  DateTime
  deleted_at             DateTime?

  animal      animales    @relation(fields: [animal_id], references: [animal_id])
  tipo_evento tipo_evento @relation(fields: [tipo_evento_id], references: [tipo_evento_id])
  veterinario usuarios    @relation("EventoSanitarioVeterinario", fields: [usuario_veterinario_id], references: [usuario_id])
  operador    usuarios    @relation("EventoSanitarioOperador", fields: [usuario_operador_id], references: [usuario_id])

  insumos_usados evento_insumo[]
}

model evento_insumo {
  evento_sanitario_id Int
  insumo_id           Int
  cantidad            Int
  deleted_at          DateTime?

  evento_sanitario evento_sanitario @relation(fields: [evento_sanitario_id], references: [evento_sanitario_id])
  insumo           insumos          @relation(fields: [insumo_id], references: [insumo_id])

  @@id([evento_sanitario_id, insumo_id])
}

model alimentacion {
  alimentacion_id     Int       @id @default(autoincrement())
  insumo_id           Int
  usuario_operador_id Int
  animal_id           Int
  cantidad            Int
  fecha               DateTime
  deleted_at          DateTime?

  insumo  insumos  @relation(fields: [insumo_id], references: [insumo_id])
  usuario usuarios @relation(fields: [usuario_operador_id], references: [usuario_id])
  animal  animales @relation(fields: [animal_id], references: [animal_id])
}

model pesajes {
  pesaje_id           Int       @id @default(autoincrement())
  usuario_operador_id Int
  animal_id           Int
  unidad_id           Int
  peso                Decimal   @db.Decimal(10, 2)
  fecha               DateTime
  deleted_at          DateTime?

  usuario usuarios @relation(fields: [usuario_operador_id], references: [usuario_id])
  animal  animales @relation(fields: [animal_id], references: [animal_id])
  unidad  unidades @relation(fields: [unidad_id], references: [unidad_id])
}

model produccion_carne {
  produccion_id       Int       @id @default(autoincrement())
  animal_id           Int
  usuario_operador_id Int
  fecha               DateTime
  deleted_at          DateTime?

  animal  animales @relation(fields: [animal_id], references: [animal_id])
  usuario usuarios @relation(fields: [usuario_operador_id], references: [usuario_id])
}

model produccion_lechera {
  produccion_id      Int       @id @default(autoincrement())
  usuario_ordeño_id Int
  animal_id          Int
  cantidad           Int
  unidad_id          Int
  fecha              DateTime
  descripcion        String?
  deleted_at         DateTime?

  usuario usuarios @relation(fields: [usuario_ordeño_id], references: [usuario_id])
  animal  animales @relation(fields: [animal_id], references: [animal_id])
  unidad  unidades @relation(fields: [unidad_id], references: [unidad_id])
}

model evento_monta {
  monta_id               Int       @id @default(autoincrement())
  usuario_veterinario_id Int
  animal_hembra_id       Int
  animal_macho_id        Int
  tipo_evento_id         Int
  fecha                  DateTime
  deleted_at             DateTime?

  veterinario usuarios    @relation(fields: [usuario_veterinario_id], references: [usuario_id])
  hembra      animales    @relation("MontaHembra", fields: [animal_hembra_id], references: [animal_id])
  macho       animales    @relation("MontaMacho", fields: [animal_macho_id], references: [animal_id])
  tipo_evento tipo_evento @relation(fields: [tipo_evento_id], references: [tipo_evento_id])

  diagnosticos diagnostico_preñez[]
}

model diagnostico_preñez {
  preñez_id             Int       @id @default(autoincrement())
  monta_id               Int
  usuario_veterinario_id Int
  metodo                 String?   @db.VarChar(100)
  resultado              Boolean?
  fecha_probable_parto   DateTime?
  fecha                  DateTime
  deleted_at             DateTime?

  monta       evento_monta @relation(fields: [monta_id], references: [monta_id])
  veterinario usuarios     @relation(fields: [usuario_veterinario_id], references: [usuario_id])
}

model evento_parto {
  evento_id              Int       @id @default(autoincrement())
  animal_id              Int
  usuario_veterinario_id Int
  usuario_operador_id    Int
  tipo_evento_id         Int
  descripcion            String?
  fecha                  DateTime
  deleted_at             DateTime?

  animal      animales    @relation(fields: [animal_id], references: [animal_id])
  veterinario usuarios    @relation("PartoVeterinario", fields: [usuario_veterinario_id], references: [usuario_id])
  operador    usuarios    @relation("PartoOperador", fields: [usuario_operador_id], references: [usuario_id])
  tipo_evento tipo_evento @relation(fields: [tipo_evento_id], references: [tipo_evento_id])
}
